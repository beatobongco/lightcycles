!function(){"use strict";const e=16,n=36*e,t=36*e,o=6,r=3,s=[3,4,6,14,16],i=6,l=4,a=new Two.Vector(-1,0),c=new Two.Vector(1,0),d=new Two.Vector(0,-1),u=new Two.Vector(0,1),p="lightcycles/HISCORE",m=new Two({width:n,height:t}).appendTo(document.getElementById("stage"));function g(e,o=null,r=2){function s(e,n,t=0){if(!(e.right<n.left+t||e.left>n.right-t||e.bottom<n.top+t||e.top>n.bottom-t))return!0}const i={didCollide:!1};if(G.bit&&s(e,G.bit.getBoundingClientRect())&&(i.obtainedBit=!0),e.right>=n||e.left<=0||e.bottom>=t||e.top<=0)return i.didCollide=!0,i;const l=o?o.lightTrails:[];for(let n=0;n<G.players.length;n++){if(o&&o.name!==G.players[n].name&&s(e,G.players[n].group._collection[1].getBoundingClientRect(),r))return i.didCollide=!0,i;for(let t=0;t<G.players[n].lightTrails.length;t++){let p=G.players[n].lightTrails[t];if(o&&(l[l.length-1]&&l[l.length-1].id===p.id||l[l.length-2]&&l[l.length-2].id===p.id))continue;let m=p.getBoundingClientRect();s(e,m,r)&&(i.didCollide=!0,e.right>m.right?i.oppositeDir=c:e.left<m.left?i.oppositeDir=a:e.bottom>m.bottom?i.oppositeDir=u:e.top<m.top&&(i.oppositeDir=d))}}return i}function f(e,n){return g(e.group._collection[1].getBoundingClientRect(),e,n)}const y={"sound/speed1.ogg":!1,"sound/speed2.ogg":!1,"sound/speed3.ogg":!1,"sound/slipstream.ogg":!1,"sound/shiftup.mp3":!1,"sound/rezzin.ogg":!1,"sound/bit_spawn.ogg":!1,"sound/playerjoin.ogg":!1,"sound/derezz.mp3":!1,"sound/timertick.ogg":!1};function h(){G.players.forEach(async function(e){await e.soundPromise,e.sound.pause()})}function w(){new Audio("sound/bit_spawn.ogg").play()}function k(e,n){return e=Math.ceil(e),n=Math.floor(n),Math.floor(Math.random()*(n-e+1))+e}function v(e,n,t,o,r,s,l=1,a=3,c=i){const d=[];for(let i=0;i<r;i++){const r=m.makePolygon(e.x+k(-c,c),e.y+k(-c,c),k(l,a),3);r.fill=n,r.noStroke(),r.rotation=k(-10,10),r.translation.addSelf(new Two.Vector(k(t*c,t*s),k(o*c,o*s))),d.push(r)}return m.makeGroup(...d)}function T(e){let n=0,t=0;return"up"===e?t=1:"down"===e?t=-1:"right"===e?n=-1:"left"===e&&(n=1),{oppX:n,oppY:t}}let b=null;function C(){const e=document.getElementById("timer").classList;G.timeLeft<=5?(e.contains("time-low")||e.add("time-low"),new Audio("sound/timertick.ogg").play()):e.contains("time-low")&&e.remove("time-low")}const E=(e,n)=>(clearInterval(G.gameTimer),G.timeLeft=e,document.getElementById("timer").classList.remove("time-low"),document.getElementById("timer").innerText=e,b=Date.now(),C(),setInterval(function(){const t=Date.now()-b,o=document.getElementById("timer");G.timeLeft=e-Math.floor(t/1e3),o.innerText=G.timeLeft,G.timeLeft<=0&&n&&(n(),clearInterval(G.gameTimer)),C()},1e3));function F(e,n,t){document.getElementById(e).innerHTML=`\n    <h3>${n}</h3>\n    <div class="blink">\n      <p><small class="tiny">PRESS</small></p>\n      <p class="centered">${t}</p>\n      <p><small class="tiny">TO JOIN</small></p>\n    </div>\n  `}function O(e){const{el:n,name:t,wins:o,roundWins:r,speed:s,score:i}=e;let l="",a="",c="";if("2P"===G.mode){let e=['<span class="windot">&#9675;</span>','<span class="windot">&#9675;</span>','<span class="windot">&#9675;</span>'];for(let n=0;n<r;n++)e[n]='<span class="windot">&#9679;</span>';l=`<p><small>ROUND</small></p>\n    <div class="rounds">${e.join("")}</div>`,a=o>0?`<small class="tiny">\n            WINS: <span id="${t}-wins">${o}</span>\n          </small>`:""}else if("1P"===G.mode){c=`<p><small>SCORE</small></p>\n    <p><small>${i}</small></p>`;const e=localStorage.getItem(p);e>0&&(c+=`<p><small>RECORD</small></p>\n    <p><small>${e}</small></p>`)}document.getElementById(n).innerHTML=`\n    <div>\n      <h3>${t}</h3>\n      ${l}\n      <p><small>SPEED</small></p>\n      <h3 id="${t}-speed">${s}</h3>\n      ${a}\n      ${c}\n    </div>`}function R(e,n,t,o){const r=m.makeCircle(e,n,i);r.stroke=t,r.fill=o,r.linewidth=2;const s=m.makeRectangle(e,n,l,l);s.fill="red",s.noFill(),s.noStroke();const a=m.makeGroup(r,s);return a.center(),a.translation.set(e,n),a}function D(e,n,t,o,r,s,i,l,a,c,d){const u={el:d,name:e,prevDirection:o,direction:o,lastMoveFrame:0,_speed:1,get speed(){return this._speed},set speed(n){document.getElementById(`${e}-speed`).innerText=n,this._speed=n},get wins(){return this._wins},set wins(e){this._wins=e,O(this)},_roundWins:s,get roundWins(){return this._roundWins},set roundWins(e){this._roundWins=e,O(this)},_score:0,get score(){return this._score},set score(e){this._score=e,O(this)},isAccelerating:!1,isBraking:!1,lastDecelerateFrame:0,lastAccelerateFrame:0,lastBrakeFrame:0,alive:!0,_wins:r,group:R(n,t,i,l),fillColor:l,strokeColor:i,originalStroke:i,turboColor:a,sparkColor:c,currentOrigin:new Two.Vector(n,t),lightTrails:[],corpse:null,sparks:null,sound:new Audio,soundPromise:null};return O(u),u}function P(t=!1){return D("P1",Math.round(n/2),8*e,"down",G.user?G.user.wins:0,t&&G.user?G.user.roundWins:0,"#3498db","#ffffff","#67CBFF","#E7FFFF","userHud")}function A(o=!1){return D("P2",Math.round(n/2),t-8*e,"up",G.enemy?G.enemy.wins:0,o&&G.enemy?G.enemy.roundWins:0,"#e67e22","#000000","#FFB155","#FFFFD5","enemyHud")}function S(e=!1){1===G.noPlayer?(G.enemy=A(0),G.players=[G.enemy],F("userHud","P1","W")):2===G.noPlayer?(G.user=P(0),G.players=[G.user],F("enemyHud","P2",'<span>UP</span> <small class="tiny">ARROW<small>')):(G.user=P(e),G.enemy=A(e),G.players=[G.user,G.enemy])}function I(){let e,o,r;G.bit&&m.remove(G.bit),(r=m.makeCircle(0,0,6)).fill="#1abc9c",r.noStroke(),r.opacity=.9,(o=m.makeCircle(0,0,4)).fill="#E6FFFF",o.noStroke(),(e=m.makeGroup(r,o)).center(),e.translation.set(k(0,n),k(0,t)),G.bit=e,g(G.bit.getBoundingClientRect()).didCollide?(console.log("bit collided"),I()):w()}const B="KeyT",x="BracketRight";function $(e,n){("down"===n&&"up"!==e.prevDirection||"up"===n&&"down"!==e.prevDirection||"right"===n&&"left"!==e.prevDirection||"left"===n&&"right"!==e.prevDirection)&&(e.direction=n)}function W(e){e.isAccelerating||new Audio("sound/shiftup.mp3").play(),e.isAccelerating=!0}function M(){new Audio("sound/playerjoin.ogg").play(),G.firstRun=!0,G.noPlayer=null,G.mode="2P",G.roundTime=30,m.remove(G.bit),L()}function L(){m.pause(),G.players.length>0&&(G.players.forEach(e=>{m.remove(e.group),m.remove(e.corpse),m.remove(e.sparks),e.lightTrails.forEach(e=>{m.remove(e)})}),h()),G.gameOverText=null,G.gameOver=!1,document.getElementById("gameOverContainer").style.display="none",!G.players||G.players.some(e=>3===e.roundWins)?S():S(!0),m.update(),h(),new Audio("sound/rezzin.ogg").play(),G.gameTimer=E(3,()=>{G.gameTimer=E(G.roundTime,()=>{G.gameOver=!0}),G.noPlayer&&I(),G.players.forEach(e=>{e.sound.src="sound/speed1.ogg",e.soundPromise=e.sound.play().catch(e=>{})}),G.instance.play()})}function _(e,n){let t=0;e.isAccelerating?e.speed<o&&n-e.lastAccelerateFrame>s[e.speed-1]&&(e.speed+=1,e.lastAccelerateFrame=n):n-e.lastDecelerateFrame>r&&e.speed>1&&(e.speed-=1,e.lastDecelerateFrame=n);const p=f(e,-3);p.didCollide&&(t=Math.ceil(.5*e.speed),e.strokeColor!==e.turboColor&&e.speed+t>o&&(e.strokeColor=e.turboColor,e.currentOrigin=e.group.translation.clone())),e.strokeColor===e.turboColor&&e.speed+t<=o&&(e.strokeColor=e.originalStroke,e.currentOrigin=e.group.translation.clone());let g=Math.round(Math.max(0,6/Math.max(1,e.speed+t)));e.speed===o&&(g=0);let y=e.direction;const h=e.group.translation;for(let o=1;o<=e.speed+t;o++){switch("P2"===G.mode&&(e.score+=1),e.direction!==e.prevDirection&&n-e.lastMoveFrame>g?(e.currentOrigin=e.group.translation.clone(),e.prevDirection=y,e.lastMoveFrame=n,e.sound.currentTime=0):y=e.prevDirection,y){case"left":h.addSelf(a);break;case"right":h.addSelf(c);break;case"up":h.addSelf(d);break;case"down":h.addSelf(u)}if(1===o||o%l==0){const n=f(e);if(n.didCollide){new Audio("sound/derezz.mp3").play(),e.alive=!1,m.remove(e.group);const{oppX:n,oppY:t}=T(y);return void(e.corpse=v(e.group.translation,e.fillColor,n,t,k(3,3*e.speed),i*e.speed*(e.speed/2),2,3))}n.obtainedBit&&(C=10,b=Date.now(),G.timeLeft=C,e.score+=250,w(),I())}}var C;if(function(e,n){async function t(e,n){const t=e.sound.src.split("/");n!==t.slice(t.length-2,t.length).join("/")&&(await e.soundPromise,e.sound.src=n,e.soundPromise=e.sound.play().catch(e=>{}))}e.isAccelerating&&!e.isBraking?e.speed+n>o?t(e,"sound/slipstream.ogg"):e.speed===o?t(e,"sound/speed3.ogg"):t(e,"sound/speed2.ogg"):t(e,"sound/speed1.ogg")}(e,t),function(e){const n=m.makeLine(e.currentOrigin.x,e.currentOrigin.y,e.group.translation.x,e.group.translation.y);if(n.stroke=e.strokeColor,n.linewidth=6,n.opacity=.9,n.origin=e.currentOrigin,e.lightTrails.length>0){const t=e.lightTrails[e.lightTrails.length-1];t.origin.equals(n.origin)&&t.stroke===n.stroke&&m.remove(e.lightTrails.pop())}e.lightTrails.push(n)}(e),m.remove(e.sparks),p.didCollide){const n=1+e.speed,{x:t,y:o}=p.oppositeDir||{x:0,y:0},{oppX:r,oppY:s}=T(y);e.sparks=v(e.group.translation,e.sparkColor,t+r*n,o+s*n,k(3,3+e.speed),1+Math.round(2*e.speed),2,2,i/2)}return m.remove(e.group),e.group=R(h.x,h.y,e.strokeColor,e.fillColor),y}Object.keys(y).forEach(e=>{new Audio(e).addEventListener("canplaythrough",()=>{y[e]=!0})}),function(){const o=m.makeRectangle(n/2,t/2,n,t);o.fill="#2c3e50",o.stroke="#ecf0f1",o.linewidth=3;for(let o=0;o<=n;o+=e)m.makeLine(o,0,o,t).stroke="#fff";for(let o=0;o<=t;o+=e)m.makeLine(0,o,n,o).stroke="#fff";m.update()}(),document.body.onkeydown=(e=>{if("KeyR"===e.code){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),G.gameOver&&L()}else if("Pause"===e.code&&G.pauseEnabled)G.instance.playing?G.instance.pause():G.instance.play();else if(!G.enemy&&"ArrowUp"===e.code||!G.user&&"KeyW"===e.code)M();else if(!G.gameOver){if(G.user)switch(e.code){case"KeyS":$(G.user,"down");break;case"KeyW":$(G.user,"up");break;case"KeyA":$(G.user,"left");break;case"KeyD":$(G.user,"right");break;case B:W(G.user)}if(G.enemy)switch(e.code){case"ArrowDown":$(G.enemy,"down");break;case"ArrowUp":$(G.enemy,"up");break;case"ArrowLeft":$(G.enemy,"left");break;case"ArrowRight":$(G.enemy,"right");break;case x:W(G.enemy)}}}),document.body.onkeyup=(e=>{if(!G.gameOver)switch(e.code){case B:G.user&&(G.user.isAccelerating=!1);break;case x:G.enemy&&(G.enemy.isAccelerating=!1)}}),G.instance=m.bind("update",e=>{if(stats.begin(),G.gameOver){clearInterval(G.gameTimer);let e="Press `R` to play next round.";if("1P"===G.mode){let n=G.players[0].score;n>(localStorage.getItem(p)||0)?(localStorage.setItem(p,n),e=`You set a new record, ${n} pts!`):e=`You got ${n} pts!`,e+="<p>Press `R` to try again. </p>"}if(G.players.every(e=>!e.alive))"2P"===G.mode?G.gameOverText="DRAW":G.gameOverText="YOU DEREZZED";else if(G.timeLeft<=0){if(G.gameOverText="TIME UP","2P"===G.mode){let n=null,t=0,o="";G.players.forEach(e=>{o+=`<p>${e.name}: ${e.score} pts</p>`,e.score>t?(t=e.score,n=e):e.score===t&&(n=null)}),n?(n.roundWins+=1,e=`${n.name} WINS <p>${n.name} has a longer jetwall. </p>\n          ${o}\n          <p>${e}</p>`):e=`DRAW. <p>${e} </p>`}}else G.players.some(e=>{if(e.alive)return G.gameOverText=`${e.name} WINS`,e.roundWins+=1,!0});document.getElementById("gameOverSubtext").innerHTML=e,G.players.some(e=>{if(3===e.roundWins)return e.wins+=1,G.gameOverText=`${e.name} WINS THE MATCH`,document.getElementById("gameOverSubtext").innerText="Press `R` for rematch.",!0}),document.getElementById("gameOverContainer").style.display="flex",document.getElementById("gameOverText").innerText=G.gameOverText,h(),m.pause()}else{for(let n=0;n<G.players.length;n++)_(G.players[n],e);for(let e=0;e<G.players.length;e++)G.players[e].alive||(G.gameOver=!0)}stats.end()})}();
