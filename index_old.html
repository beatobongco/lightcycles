<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>> lightmagnets $</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" /> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/two.js/0.6.0/two.js"></script>
  </head>
  <body>
    <div id="stage"></div>
    <script>
      // https://gist.github.com/cyphunk/6c255fa05dd30e69f438a930faeb53fe#gistcomment-2661027
      function softmax(arr) {
        const C = Math.max(...arr);
        const d = arr.map(y => Math.exp(y - C)).reduce((a, b) => a + b);
        return arr.map((value, index) => {
          return Math.exp(value - C) / d;
        });
      }

      const elem = document.getElementById('stage');
      const stageWidth = 128;
      const stageHeight = 128;
      const moveLength = 20;
      const speed = 1;
      const two = new Two({
        width: stageWidth,
        height: stageHeight
      }).appendTo(elem);

      const stage = two.makeRectangle(
        stageWidth / 2,
        stageHeight / 2,
        stageWidth,
        stageHeight
      );
      stage.stroke = '#2c3e50';
      stage.linewidth = 1;

      const dontMove = new Two.Vector(0, 0);
      const user = {
        name: 'user',
        currentMove: dontMove,
        group: two.makeCircle(5, 5, 5)
      };
      const enemy = {
        name: 'enemy',
        currentMove: dontMove,
        group: two.makeCircle(stageWidth - 5, stageHeight - 5, 5)
      };
      user.group.fill = '#3498db';
      user.linewidth = 0;
      enemy.linewidth = 0;
      enemy.group.fill = '#e67e22';

      user.target = enemy.group.translation;
      enemy.target = user.group.translation;

      const right = new Two.Vector(speed, 0);
      const up = new Two.Vector(0, -speed);
      const left = new Two.Vector(-speed, 0);
      const down = new Two.Vector(0, speed);
      const directions = [right, up, left, down]; //{ right: right, up: up, left: left, down: down };
      const directionKeys = ['right', 'up', 'left', 'down'];
      const origin = new Two.Vector(0, 0);

      function checkLegal(vec) {
        if (
          vec.x > origin.x && // doesn't go left
          vec.x <= stageWidth && // doesn't go right
          vec.y >= origin.y && // doesn't go up
          vec.y < stageHeight // doesn't go down
        ) {
          return true;
        }
        return false;
      }

      function immutableVAdd(vec1, vec2) {
        tempsum = new Two.Vector(0, 0);
        return tempsum.add(vec1, vec2);
      }

      function immutableVSub(vec1, vec2) {
        temp = new Two.Vector(0, 0);
        return temp.sub(vec1, vec2);
      }

      function immutableScalarMul(vec, scalar) {
        temp = new Two.Vector(0, 0);
        return temp.copy(vec).multiplyScalar(scalar);
      }

      let timeline = two.bind('update', frameCount => {
        // make user and enemy walk randomly 1 pixel
        [user, enemy].forEach(player => {
          if (frameCount % moveLength === 0) {
            const pg = player.group;
            let legal = [];

            // get legal directions
            directions.forEach((dir, index) => {
              var newPosition = immutableVAdd(
                pg.translation,
                immutableScalarMul(dir, moveLength)
              );
              if (checkLegal(newPosition)) {
                legal.push({
                  direction: dir,
                  humanReadable: directionKeys[index]
                });
              }
            });

            const diff = immutableVSub(player.target, pg.translation);
            const xboost = diff.x / stageWidth;
            const yboost = diff.y / stageHeight;

            const evenProb = Math.round((1.0 / legal.length) * 100) / 100;

            // calculate new probabilities, give each even probs
            // these represent ranges
            let pkeys = [];
            let probabilities = [];
            Object.keys(legal).forEach(k => {
              legal[k].probability = evenProb;
              if (xboost > 0 && k === 'right') {
                legal[k].probability += xboost;
              } else if (xboost < 0 && k === 'left') {
                legal[k].probability += Math.abs(xboost);
              } else if (yboost > 0 && k === 'down') {
                legal[k].probability += yboost;
              } else if (yboost < 0 && k === 'up') {
                legal[k].probability += Math.abs(yboost);
              }
              pkeys.push(k);
              probabilities.push(legal[k].probability);
            });

            // TODO: probabilities array must only have the legal probabilities
            probabilities = softmax(probabilities);

            // convert to ranges
            let sum = 0;
            legal.forEach(move => {
              sum += move.probability;
              move.probability = sum;
            });

            // console.log(player.name, legal);

            let rand = Math.random();
            let last = 0;
            legal.some(k => {
              // console.log(
              //   'comparing range',
              //   last,
              //   k.probability,
              //   'rand=',
              //   rand
              // );
              if (rand >= last && rand < k.probability) {
                // console.log(
                //   rand,
                //   player.name,
                //   'moving',
                //   k.humanReadable,
                //   pg.translation,
                //   legal
                // );
                player.currentMove = k.direction;
                return true;
              }
              last = k.probability;
            });
          }

          player.group.translation.addSelf(player.currentMove);
        });

        // check for collisions
        if (
          user.group.translation.x === enemy.group.translation.x &&
          user.group.translation.y &&
          enemy.group.translation.y
        ) {
          console.log('COLLISION!');
        }
      });
      // .play();

      const numTimes = 100;
      for (let i = 0; i < numTimes; i++) {
        two.update();
      }
    </script>
  </body>
</html>
